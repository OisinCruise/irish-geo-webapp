{% extends 'base.html' %}
{% load static %}

{% block title %}My Journey{% endblock %}

{% block extra_css %}
<style>
/* ==============================================================================
   CORK BOARD STYLES
   ============================================================================== */

.cork-board {
    min-height: calc(100vh - 120px);
    background-color: #c19a6b;
    background-image:
        radial-gradient(ellipse at 20% 30%, rgba(139, 90, 43, 0.3) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(139, 90, 43, 0.2) 0%, transparent 50%),
        repeating-linear-gradient(
            45deg,
            transparent,
            transparent 2px,
            rgba(139, 90, 43, 0.1) 2px,
            rgba(139, 90, 43, 0.1) 4px
        );
    padding: var(--spacing-xl);
    border: 12px solid #8b5a2b;
    border-radius: var(--radius-lg);
    margin: var(--spacing-lg);
    box-shadow:
        inset 0 0 50px rgba(0,0,0,0.1),
        0 10px 30px rgba(0,0,0,0.3);
}

[data-theme="dark"] .cork-board {
    background-color: #8b6b4f;
    border-color: #5a3825;
}

/* ==============================================================================
   HERO SECTION
   ============================================================================== */

.collage-hero {
    text-align: center;
    padding: var(--spacing-xl) 0;
    margin-bottom: var(--spacing-xl);
}

.collage-hero h1 {
    font-size: 2.5rem;
    color: #4a3728;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
    margin-bottom: var(--spacing-sm);
}

[data-theme="dark"] .collage-hero h1 {
    color: #f0e6d3;
}

.collage-hero p {
    font-size: 1.1rem;
    color: #6b5344;
}

[data-theme="dark"] .collage-hero p {
    color: #d4c4b0;
}

/* ==============================================================================
   STATS SUMMARY
   ============================================================================== */

.stats-summary {
    display: flex;
    justify-content: center;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
    flex-wrap: wrap;
}

.stat-item {
    background: rgba(255,255,255,0.9);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-lg);
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    min-width: 120px;
}

[data-theme="dark"] .stat-item {
    background: rgba(30,30,30,0.9);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--color-primary);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ==============================================================================
   FILTER CONTROLS
   ============================================================================== */

.filter-controls {
    display: flex;
    justify-content: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-xl);
}

.filter-btn {
    padding: var(--spacing-xs) var(--spacing-md);
    background: rgba(255,255,255,0.8);
    border: 2px solid transparent;
    border-radius: var(--radius-full);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all var(--transition-fast);
}

.filter-btn:hover,
.filter-btn.active {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
}

/* ==============================================================================
   COLLAGE GRID
   ============================================================================== */

.collage-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-xl);
    padding: var(--spacing-md);
}

/* ==============================================================================
   POLAROID CARDS
   ============================================================================== */

.polaroid {
    background: white;
    padding: 12px 12px 40px;
    box-shadow:
        0 4px 6px rgba(0,0,0,0.1),
        0 10px 20px rgba(0,0,0,0.15);
    position: relative;
    cursor: pointer;
    transition: all var(--transition-normal);
    transform-origin: center center;
}

.polaroid-upload-overlay {
    position: absolute;
    top: 12px;
    left: 12px;
    right: 12px;
    height: 200px;
    background: rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-fast);
    z-index: 5;
}

.polaroid:hover .polaroid-upload-overlay {
    opacity: 1;
}

.upload-btn {
    background: var(--color-accent);
    color: white;
    border: none;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 600;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.upload-btn:hover {
    background: var(--color-accent-dark);
    transform: scale(1.05);
}

/* Random rotations for natural look */
.polaroid:nth-child(4n+1) { transform: rotate(-2deg); }
.polaroid:nth-child(4n+2) { transform: rotate(1.5deg); }
.polaroid:nth-child(4n+3) { transform: rotate(-1deg); }
.polaroid:nth-child(4n+4) { transform: rotate(2deg); }

.polaroid:hover {
    transform: rotate(0deg) scale(1.05);
    z-index: 10;
    box-shadow:
        0 8px 16px rgba(0,0,0,0.2),
        0 20px 40px rgba(0,0,0,0.25);
}

[data-theme="dark"] .polaroid {
    background: #2d2d2d;
}

/* Push pin effect */
.polaroid::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 20px;
    border-radius: 50%;
    box-shadow:
        inset -2px -2px 4px rgba(0,0,0,0.3),
        0 2px 4px rgba(0,0,0,0.2);
}

/* Pin colors */
.polaroid:nth-child(5n+1)::before { background: linear-gradient(135deg, #e74c3c, #c0392b); }
.polaroid:nth-child(5n+2)::before { background: linear-gradient(135deg, #3498db, #2980b9); }
.polaroid:nth-child(5n+3)::before { background: linear-gradient(135deg, #2ecc71, #27ae60); }
.polaroid:nth-child(5n+4)::before { background: linear-gradient(135deg, #f1c40f, #f39c12); }
.polaroid:nth-child(5n+5)::before { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

/* Pin shine effect */
.polaroid::after {
    content: '';
    position: absolute;
    top: -6px;
    left: calc(50% - 3px);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255,255,255,0.6);
}

.polaroid-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.polaroid-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.polaroid-placeholder {
    font-size: 4rem;
    color: var(--text-muted);
}

.polaroid-content {
    padding: var(--spacing-md) 0 0;
}

.polaroid-caption {
    font-family: 'Caveat', 'Comic Sans MS', cursive;
    font-size: 1.1rem;
    color: #4a3728;
    margin-bottom: var(--spacing-xs);
    min-height: 1.5em;
}

[data-theme="dark"] .polaroid-caption {
    color: #d4c4b0;
}

.polaroid-site {
    font-weight: 600;
    color: var(--color-primary);
    font-size: 0.9rem;
    margin-bottom: var(--spacing-xs);
}

.polaroid-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.polaroid-county {
    background: var(--color-accent);
    color: white;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.7rem;
}

/* ==============================================================================
   EMPTY STATE
   ============================================================================== */

.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    background: rgba(255,255,255,0.9);
    border-radius: var(--radius-lg);
    max-width: 500px;
    margin: 0 auto;
}

[data-theme="dark"] .empty-state {
    background: rgba(30,30,30,0.9);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-md);
}

.empty-state h3 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-sm);
}

.empty-state p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-lg);
}

/* ==============================================================================
   CTA SECTION
   ============================================================================== */

.collage-cta {
    text-align: center;
    padding: var(--spacing-xl);
    margin-top: var(--spacing-xl);
    background: rgba(255,255,255,0.8);
    border-radius: var(--radius-lg);
}

[data-theme="dark"] .collage-cta {
    background: rgba(30,30,30,0.8);
}

/* ==============================================================================
   MODAL
   ============================================================================== */

.photo-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-lg);
}

.photo-modal.active {
    display: flex;
}

.modal-content {
    background: white;
    max-width: 800px;
    max-height: 90vh;
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
}

[data-theme="dark"] .modal-content {
    background: var(--bg-card);
}

.modal-close {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 1;
}

.modal-image {
    width: 100%;
    max-height: 60vh;
    object-fit: contain;
}

.modal-details {
    padding: var(--spacing-lg);
}

.modal-site-name {
    font-size: 1.5rem;
    color: var(--color-primary);
    margin-bottom: var(--spacing-xs);
}

.modal-caption {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-md);
}

.modal-meta {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: var(--text-muted);
}

/* ==============================================================================
   LOADING STATE
   ============================================================================== */

.loading-state {
    text-align: center;
    padding: var(--spacing-xl);
}

.loading-spinner-large {
    width: 60px;
    height: 60px;
    border: 4px solid var(--border-color);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto var(--spacing-md);
}

/* ==============================================================================
   RESPONSIVE
   ============================================================================== */

@media (max-width: 768px) {
    .cork-board {
        margin: var(--spacing-sm);
        padding: var(--spacing-md);
        border-width: 8px;
    }

    .collage-hero h1 {
        font-size: 1.8rem;
    }

    .stats-summary {
        flex-direction: column;
        align-items: center;
    }

    .collage-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--spacing-lg);
    }

    .polaroid {
        padding: 8px 8px 30px;
    }

    .polaroid-image {
        height: 150px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="cork-board">
    <!-- Hero Section -->
    <div class="collage-hero">
        <h1 data-en="My Journey Through Ireland" data-ga="Mo Thuras TrÃ­d Ã‰irinn">
            My Journey Through Ireland
        </h1>
        <p data-en="A collection of memories from historical sites I've explored"
           data-ga="BailiÃºchÃ¡n cuimhnÃ­ Ã³ shuÃ­omhanna stairiÃºla a d'iniÃºch mÃ©">
            A collection of memories from historical sites I've explored
        </p>
    </div>

    <!-- Stats Summary -->
    <div class="stats-summary">
        <div class="stat-item">
            <div class="stat-number" id="totalPhotos">0</div>
            <div class="stat-label" data-en="Photos" data-ga="Grianghraif">Photos</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="countiesVisited">0</div>
            <div class="stat-label" data-en="Counties" data-ga="Contaetha">Counties</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="sitesExplored">0</div>
            <div class="stat-label" data-en="Sites Explored" data-ga="SuÃ­omhanna">Sites Explored</div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls" id="filterControls">
        <button class="filter-btn active" data-filter="all"
                data-en="All" data-ga="Gach">All</button>
    </div>

    <!-- Loading State -->
    <div class="loading-state" id="loadingState">
        <div class="loading-spinner-large"></div>
        <p data-en="Loading your journey..." data-ga="Ag lÃ³dÃ¡il do thuras...">Loading your journey...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ðŸ“·</div>
        <h3 data-en="No memories yet" data-ga="Gan cuimhnÃ­ fÃ³s">No memories yet</h3>
        <p data-en="Start exploring Ireland's historical sites and mark them as visited to build your journey collection."
           data-ga="Tosaigh ag taiscÃ©aladh suÃ­omhanna stairiÃºla na hÃ‰ireann agus marcÃ¡il iad mar a tugadh cuairt orthu chun do bhailiÃºchÃ¡n turais a thÃ³gÃ¡il.">
            Start exploring Ireland's historical sites and mark them as visited to build your journey collection.
        </p>
        <a href="{% url 'explore' %}" class="btn btn-accent"
           data-en="Start Exploring" data-ga="Tosaigh ag TaiscÃ©aladh">
            Start Exploring
        </a>
    </div>

    <!-- Collage Grid -->
    <div class="collage-grid" id="collageGrid" style="display: none;"></div>

    <!-- CTA Section -->
    <div class="collage-cta" id="ctaSection" style="display: none;">
        <h3 data-en="Continue Your Journey" data-ga="Lean ar Aghaidh le Do Thuras">Continue Your Journey</h3>
        <p data-en="Discover more of Ireland's fascinating historical sites"
           data-ga="Faigh amach nÃ­os mÃ³ faoi shuÃ­omhanna stairiÃºla suntasacha na hÃ‰ireann">
            Discover more of Ireland's fascinating historical sites
        </p>
        <a href="{% url 'explore' %}" class="btn btn-primary"
           data-en="Explore the Map" data-ga="TaiscÃ©al an LÃ©arscÃ¡il">
            Explore the Map
        </a>
    </div>
</div>

<!-- Photo Modal -->
<div class="photo-modal" id="photoModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <img class="modal-image" id="modalImage" src="" alt="">
        <div class="modal-details">
            <h2 class="modal-site-name" id="modalSiteName"></h2>
            <p class="modal-caption" id="modalCaption"></p>
            <div class="modal-meta">
                <span id="modalCounty"></span>
                <span id="modalDate"></span>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="photo-modal" id="uploadModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        <div class="modal-details">
            <h2 class="modal-site-name" id="uploadSiteName"></h2>
            <form id="uploadForm" enctype="multipart/form-data" style="margin-top: 20px;">
                <input type="hidden" id="uploadItemId" name="item_id">

                <div style="margin-bottom: 15px;">
                    <label for="photoInput" style="display: block; margin-bottom: 8px; font-weight: 600;">
                        ðŸ“· Upload Photo
                    </label>
                    <input
                        type="file"
                        id="photoInput"
                        name="photo"
                        accept="image/*"
                        required
                        style="width: 100%; padding: 8px; border: 2px dashed var(--border-color); border-radius: var(--radius-md);"
                    >
                    <small style="color: var(--text-muted);">Max size: 5MB. Formats: JPG, PNG, GIF</small>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="captionInput" style="display: block; margin-bottom: 8px; font-weight: 600;">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        Add a Caption (Optional)
                    </label>
                    <textarea
                        id="captionInput"
                        name="photo_caption"
                        rows="3"
                        placeholder="Share your memory of this place..."
                        style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-md); resize: vertical; font-family: inherit;"
                    ></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button
                        type="submit"
                        class="btn btn-accent"
                        style="flex: 1;"
                    >
                        Upload Photo
                    </button>
                    <button
                        type="button"
                        class="btn btn-outline"
                        onclick="closeUploadModal()"
                    >
                        Cancel
                    </button>
                </div>

                <div id="uploadProgress" style="display: none; margin-top: 15px; text-align: center;">
                    <div class="loading-spinner-large"></div>
                    <p style="margin-top: 10px; color: var(--text-muted);">Uploading...</p>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ==============================================================================
// COLLAGE WALL JAVASCRIPT
// ==============================================================================

let bucketListItems = [];
let uniqueCounties = new Set();

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    fetchBucketListData();
});

// Fetch bucket list data from API
async function fetchBucketListData() {
    try {
        const response = await fetch('/api/v1/bucket-list/?status=visited');

        if (!response.ok) {
            throw new Error('Failed to fetch data');
        }

        const data = await response.json();
        bucketListItems = data.results || data || [];

        // Process data
        processData();

    } catch (error) {
        console.error('Error fetching bucket list:', error);
        // Show empty state on error
        showEmptyState();
    }
}

// Process and display data
function processData() {
    document.getElementById('loadingState').style.display = 'none';

    if (bucketListItems.length === 0) {
        showEmptyState();
        return;
    }

    // Calculate unique counties
    bucketListItems.forEach(item => {
        if (item.site && item.site.county_name) {
            uniqueCounties.add(item.site.county_name);
        }
    });

    // Update stats
    updateStats();

    // Build filter buttons
    buildFilterButtons();

    // Render collage grid
    renderCollageGrid(bucketListItems);

    // Show grid and CTA
    document.getElementById('collageGrid').style.display = 'grid';
    if (bucketListItems.length < 10) {
        document.getElementById('ctaSection').style.display = 'block';
    }
}

// Show empty state
function showEmptyState() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
}

// Update statistics
function updateStats() {
    document.getElementById('totalPhotos').textContent =
        bucketListItems.filter(item => item.photo).length;
    document.getElementById('countiesVisited').textContent = uniqueCounties.size;
    document.getElementById('sitesExplored').textContent = bucketListItems.length;
}

// Build filter buttons for counties
function buildFilterButtons() {
    const container = document.getElementById('filterControls');

    uniqueCounties.forEach(county => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.filter = county;
        btn.textContent = county;
        btn.onclick = function() { filterByCounty(county, this); };
        container.appendChild(btn);
    });
}

// Filter collage by county
function filterByCounty(county, btn) {
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Filter items
    const filtered = county === 'all'
        ? bucketListItems
        : bucketListItems.filter(item => item.site && item.site.county_name === county);

    renderCollageGrid(filtered);
}

// Render the collage grid
function renderCollageGrid(items) {
    const grid = document.getElementById('collageGrid');
    grid.innerHTML = '';

    items.forEach((item, index) => {
        const card = createPolaroidCard(item, index);
        grid.appendChild(card);
    });
}

// Create a polaroid card element
function createPolaroidCard(item, index) {
    const card = document.createElement('div');
    card.className = 'polaroid';

    const site = item.site || {};
    const hasPhoto = item.photo && item.photo !== '';
    const visitedDate = item.visited_at ? new Date(item.visited_at).toLocaleDateString() : '';

    card.innerHTML = `
        ${!hasPhoto ? `
        <div class="polaroid-upload-overlay">
            <button
                class="upload-btn"
                onclick="event.stopPropagation(); openUploadModal(${item.id}, '${site.name_en || 'Unknown Site'}')"
            >
                <span>ðŸ“·</span>
                <span>Upload Photo</span>
            </button>
        </div>
        ` : ''}
        <div class="polaroid-image">
            ${hasPhoto
                ? `<img src="${item.photo}" alt="${site.name_en || 'Site photo'}" loading="lazy">`
                : `<span class="polaroid-placeholder"><svg viewBox="0 0 24 24" width="64" height="64" fill="currentColor"><path d="M21 9V7l-2-1V2h-2v2h-2V2h-2v2h-2V2H9v2H7V2H5v4L3 7v2l2 1v11h6v-5h2v5h6V10l2-1zm-4 9h-2v-2h-2v2H9v-5H7V7h10v6h-2v5h2z"/></svg></span>`
            }
        </div>
        <div class="polaroid-content">
            <p class="polaroid-caption">${item.photo_caption || ''}</p>
            <p class="polaroid-site">${site.name_en || 'Unknown Site'}</p>
            <div class="polaroid-meta">
                <span class="polaroid-county">${site.county_name || 'Ireland'}</span>
                <span class="polaroid-date">${visitedDate}</span>
            </div>
        </div>
    `;

    // Only add click handler if there's a photo (for viewing)
    if (hasPhoto) {
        card.onclick = () => openModal(item);
    }

    return card;
}

// Open modal with photo details
function openModal(item) {
    const modal = document.getElementById('photoModal');
    const site = item.site || {};

    document.getElementById('modalImage').src = item.photo || '';
    document.getElementById('modalImage').style.display = item.photo ? 'block' : 'none';
    document.getElementById('modalSiteName').textContent = site.name_en || 'Unknown Site';
    document.getElementById('modalCaption').textContent = item.photo_caption || 'No caption';
    document.getElementById('modalCounty').innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align: middle;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${site.county_name || 'Ireland'}`;
    document.getElementById('modalDate').innerHTML = item.visited_at
        ? `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align: middle;"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg> ${new Date(item.visited_at).toLocaleDateString()}`
        : '';

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Close modal
function closeModal() {
    document.getElementById('photoModal').classList.remove('active');
    document.body.style.overflow = '';
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Close modal on background click
document.getElementById('photoModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Handle "All" filter button
document.querySelector('.filter-btn[data-filter="all"]').onclick = function() {
    filterByCounty('all', this);
};

// ==============================================================================
// IMAGE UPLOAD FUNCTIONALITY
// ==============================================================================

// Open upload modal
function openUploadModal(itemId, siteName) {
    const modal = document.getElementById('uploadModal');
    document.getElementById('uploadItemId').value = itemId;
    document.getElementById('uploadSiteName').textContent = siteName;
    document.getElementById('photoInput').value = '';
    document.getElementById('captionInput').value = '';

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Close upload modal
function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
    document.body.style.overflow = '';
}

// Get CSRF token from meta tag or cookie
function getCsrfToken() {
    // First try to get from meta tag
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.content) {
        return metaTag.content;
    }
    
    // Then try the hidden input
    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfInput && csrfInput.value) {
        return csrfInput.value;
    }

    // Fallback to cookie
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle upload form submission
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const itemId = document.getElementById('uploadItemId').value;
    const photoInput = document.getElementById('photoInput');
    const caption = document.getElementById('captionInput').value;
    const progress = document.getElementById('uploadProgress');

    if (!photoInput.files || photoInput.files.length === 0) {
        alert('Please select a photo to upload');
        return;
    }

    const file = photoInput.files[0];

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        return;
    }

    // Show progress
    progress.style.display = 'block';

    try {
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('photo', file);
        if (caption) {
            formData.append('photo_caption', caption);
        }

        // Upload using PATCH request
        const response = await fetch(`/api/v1/bucket-list/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Upload failed');
        }

        // Success! Close modal and reload page
        closeUploadModal();
        alert('Photo uploaded successfully!');

        // Reload the page to show the new photo
        location.reload();

    } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload photo: ' + error.message);
        progress.style.display = 'none';
    }
});

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeUploadModal();
    }
});

// Close upload modal on background click
document.getElementById('uploadModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUploadModal();
    }
});
</script>
{% endblock %}
