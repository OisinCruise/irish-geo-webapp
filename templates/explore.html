{% extends 'base.html' %}
{% load static %}

{% block title %}Explore Map{% endblock %}

{% block extra_css %}
<style>
    /* Override footer for map page */
    .footer { display: none; }
    .main-content { min-height: auto; }
</style>
{% endblock %}

{% block footer %}{% endblock %}

{% block content %}
<div class="map-container">
    <!-- Main Map -->
    <div id="map"></div>

    <!-- Main Toolbar (Top Left) -->
    <div class="map-toolbar" id="mainToolbar">
        <!-- Location Tools Group -->
        <div class="toolbar-section">
            <span class="toolbar-section-label" data-en="Location" data-ga="Su√≠omh">Location</span>
            <div class="toolbar-buttons">
                <button class="toolbar-btn" id="locateBtn" title="Find my location" data-tooltip="My Location">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="coordBtn" title="Show coordinates" data-tooltip="Coordinates">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 2.88-2.88 7.19-5 9.88C9.92 16.21 7 11.85 7 9z"/>
                        <circle cx="12" cy="9" r="2.5"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="nearbyBtn" title="Find nearby sites" data-tooltip="Nearby Search">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Boundary Tools Group -->
        <div class="toolbar-section">
            <span class="toolbar-section-label" data-en="Boundaries" data-ga="Teorainneacha">Boundaries</span>
            <div class="toolbar-buttons">
                <button class="toolbar-btn" id="countyBtn" title="Toggle county borders" data-tooltip="Counties">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="provinceBtn" title="Toggle province borders" data-tooltip="Provinces">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Drawing Tools Group -->
        <div class="toolbar-section">
            <span class="toolbar-section-label" data-en="Tools" data-ga="Uirlis√≠">Tools</span>
            <div class="toolbar-buttons">
                <button class="toolbar-btn" id="measureBtn" title="Measurement tool" data-tooltip="Measure">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H3V8h2v4h2V8h2v4h2V8h2v4h2V8h2v4h2V8h2v8z"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="addPointBtn" title="Add custom marker" data-tooltip="Add Marker">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        <path d="M19 13h-2v2h-2v2h2v2h2v-2h2v-2h-2z"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="elevationBtn" title="Elevation profile" data-tooltip="Elevation">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="clearBtn" title="Clear drawings" data-tooltip="Clear">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- View Tools Group -->
        <div class="toolbar-section">
            <span class="toolbar-section-label" data-en="View" data-ga="Amharc">View</span>
            <div class="toolbar-buttons">
                <button class="toolbar-btn active" id="legendBtn" title="Toggle legend" data-tooltip="Legend">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M3 5h2v2H3V5zm4 0h14v2H7V5zM3 11h2v2H3v-2zm4 0h14v2H7v-2zm-4 6h2v2H3v-2zm4 0h14v2H7v-2z"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="filterBtn" title="Filter sites" data-tooltip="Filter">
                    <svg viewBox="0 0 24 24" class="toolbar-icon">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Site Count Badge -->
    <div class="site-count-badge" id="siteCountBadge">
        <span class="count-icon">üìç</span>
        <span id="siteCount">0</span>
        <span class="count-label" data-en="sites" data-ga="l√°ithre√°in">sites</span>
    </div>

    <!-- Filter Sidebar -->
    <div class="map-sidebar" id="filterSidebar">
        <div class="sidebar-header">
            <h3 data-en="Filter Sites" data-ga="Scag L√°ithre√°in">Filter Sites</h3>
            <button class="sidebar-close" id="closeSidebar">&times;</button>
        </div>
        <div class="sidebar-content">
            <!-- Site Type Filter -->
            <div class="filter-section">
                <h4 data-en="Site Type" data-ga="Cine√°l L√°ithre√°in">Site Type</h4>
                <div class="form-group">
                    <select class="form-select" id="filterSiteType">
                        <option value="" data-en="All Types" data-ga="Gach Cine√°l">All Types</option>
                        <option value="castle">Castle</option>
                        <option value="monastery">Monastery/Abbey</option>
                        <option value="fort">Fort/Ringfort</option>
                        <option value="burial_site">Burial Site/Tomb</option>
                        <option value="stone_monument">Stone Monument</option>
                        <option value="holy_well">Holy Well</option>
                        <option value="battlefield">Battlefield</option>
                        <option value="historic_house">Historic House</option>
                        <option value="archaeological_site">Archaeological Site</option>
                        <option value="church">Church/Chapel</option>
                        <option value="tower">Tower/Round Tower</option>
                        <option value="bridge">Historic Bridge</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- County Filter -->
            <div class="filter-section">
                <h4 data-en="County" data-ga="Contae">County</h4>
                <div class="form-group">
                    <select class="form-select" id="filterCounty">
                        <option value="" data-en="All Counties" data-ga="Gach Contae">All Counties</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Era Filter -->
            <div class="filter-section">
                <h4 data-en="Historical Era" data-ga="R√© Stairi√∫il">Historical Era</h4>
                <div class="form-group">
                    <select class="form-select" id="filterEra">
                        <option value="" data-en="All Eras" data-ga="Gach R√©">All Eras</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- National Monument Filter -->
            <div class="filter-section">
                <h4 data-en="Designation" data-ga="Ainmn√≠ocht">Designation</h4>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filterNationalMonument">
                        <span class="checkbox-custom"></span>
                        <span data-en="National Monuments Only" data-ga="S√©adchomhartha√≠ N√°isi√∫nta Amh√°in">
                            National Monuments Only
                        </span>
                    </label>
                </div>
            </div>

            <!-- Apply/Clear Buttons -->
            <div class="filter-actions">
                <button class="btn btn-primary" id="applyFilters"
                        data-en="Apply Filters" data-ga="Cuir Scagair√≠ i bhFeidhm">
                    Apply Filters
                </button>
                <button class="btn btn-outline" id="clearFilters"
                        data-en="Clear" data-ga="Glan">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Legend Panel -->
    <div class="map-legend" id="mapLegend">
        <div class="legend-header">
            <h4 class="legend-title" data-en="Legend" data-ga="Eochair">Legend</h4>
            <button class="legend-collapse" id="legendCollapse">‚àí</button>
        </div>
        <div class="legend-body" id="legendContent">
            <div class="legend-section">
                <h5 data-en="Site Types" data-ga="Cine√°lacha L√°ithre√°n">Site Types</h5>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #8B4513;"></span>
                    <span data-en="Castle" data-ga="Caisle√°n">Castle</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #4B0082;"></span>
                    <span data-en="Monastery" data-ga="Mainistir">Monastery</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #556B2F;"></span>
                    <span data-en="Fort/Ringfort" data-ga="D√∫n/R√°th">Fort/Ringfort</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #2F4F4F;"></span>
                    <span data-en="Burial Site" data-ga="L√°ithre√°n Adhlactha">Burial Site</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #6A5ACD;"></span>
                    <span data-en="Church" data-ga="Eaglais">Church</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #708090;"></span>
                    <span data-en="Stone Monument" data-ga="S√©adchomhartha Cloiche">Stone Monument</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color national-monument-indicator" style="background-color: #ff8c00; border: 2px solid #1a5f4a;"></span>
                    <span data-en="National Monument" data-ga="S√©adchomhartha N√°isi√∫nta">National Monument</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/map.js' %}?v=7"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Close sidebar button
    const closeSidebar = document.getElementById('closeSidebar');
    const sidebar = document.getElementById('filterSidebar');
    const filterBtn = document.getElementById('filterBtn');

    if (closeSidebar && sidebar) {
        closeSidebar.addEventListener('click', function() {
            sidebar.classList.remove('open');
            filterBtn?.classList.remove('active');
        });
    }

    // Legend collapse toggle
    const legendCollapse = document.getElementById('legendCollapse');
    const legendBody = document.getElementById('legendContent');

    if (legendCollapse && legendBody) {
        legendCollapse.addEventListener('click', function() {
            legendBody.classList.toggle('collapsed');
            legendCollapse.textContent = legendBody.classList.contains('collapsed') ? '+' : '‚àí';
        });
    }

    // Load filter options from API
    loadFilterOptions();

    // Apply/Clear filters buttons
    document.getElementById('applyFilters')?.addEventListener('click', function() {
        if (window.IrishGIS?.map?.applyFilters) {
            window.IrishGIS.map.applyFilters();
        }
    });

    document.getElementById('clearFilters')?.addEventListener('click', function() {
        if (window.IrishGIS?.map?.clearFilters) {
            window.IrishGIS.map.clearFilters();
        }
    });
});

async function loadFilterOptions() {
    // Load counties
    try {
        const countiesResponse = await fetch('/api/v1/counties/list_simple/');
        if (countiesResponse.ok) {
            const counties = await countiesResponse.json();
            const select = document.getElementById('filterCounty');
            if (select) {
                counties.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county.id;
                    option.textContent = county.name_en || county.name;
                    select.appendChild(option);
                });
            }
        }
    } catch (e) {
        console.error('Failed to load counties:', e);
    }

    // Load eras
    try {
        const erasResponse = await fetch('/api/v1/eras/');
        if (erasResponse.ok) {
            const eras = await erasResponse.json();
            const select = document.getElementById('filterEra');
            if (select) {
                eras.forEach(era => {
                    const option = document.createElement('option');
                    option.value = era.id;
                    option.textContent = `${era.name_en || era.name} (${era.start_year}-${era.end_year})`;
                    select.appendChild(option);
                });
            }
        }
    } catch (e) {
        console.error('Failed to load eras:', e);
    }
}
</script>
{% endblock %}
